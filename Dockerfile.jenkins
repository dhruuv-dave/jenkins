FROM jenkins/jenkins:lts

USER root

# Install Docker CLI
# Try official Docker repository first, fallback to docker.io if that fails
RUN apt-get update && \
    apt-get install -y \
        ca-certificates \
        curl \
        gnupg \
        lsb-release && \
    (install -m 0755 -d /etc/apt/keyrings && \
     curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
     chmod a+r /etc/apt/keyrings/docker.gpg && \
     echo \
       "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
       $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null && \
     apt-get update && \
     apt-get install -y docker-ce-cli) || \
    (echo "Falling back to docker.io package..." && \
     apt-get update && \
     apt-get install -y docker.io) && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Verify Docker CLI installation
RUN docker --version || (echo "Warning: Docker CLI installation may have failed" && exit 1)

# Create entrypoint script to fix Docker socket permissions
# This script runs as root, fixes permissions, then switches to jenkins user
RUN echo '#!/bin/bash\n\
set -e\n\
# Fix Docker socket permissions for Windows Docker Desktop and Linux\n\
if [ -S /var/run/docker.sock ]; then\n\
    echo "ðŸ”§ Fixing Docker socket permissions..."\n\
    chmod 666 /var/run/docker.sock 2>/dev/null || echo "âš ï¸  Warning: Could not change Docker socket permissions"\n\
    echo "âœ… Docker socket permissions configured"\n\
fi\n\
# Start Jenkins (jenkins.sh will handle user switching)\n\
exec /usr/local/bin/jenkins.sh "$@"' > /usr/local/bin/jenkins-entrypoint-custom.sh && \
    chmod +x /usr/local/bin/jenkins-entrypoint-custom.sh

# Keep root user - the entrypoint script will handle user switching
# The jenkins.sh script inside the container will switch to jenkins user

ENTRYPOINT ["/usr/local/bin/jenkins-entrypoint-custom.sh"]

